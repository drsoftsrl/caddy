{
    admin off
    log {
        output stdout
        format json
        level {$LOG_LEVEL:INFO}
    }
    on_demand_tls {
        # see if the domain is in the database
        ask https://ipn.anonymous-proxies.net/external/sites/domain_check/
    }
    storage file_system {
        root /data/caddy
    }
}

:443 {
    tls {
        on_demand
    }

    handle /health {
        respond "OK" 200
    }

    # FIX 1: Use a clearer wildcard or explicit host
    @ipn_subdomain {
        header_regexp host Host ^ipn-aff\..*
    }

    handle @ipn_subdomain {
        reverse_proxy https://ipn.anonymous-proxies.net {
            # FIX 2: Manually set the Host to the target's expected domain
            header_up Host ipn.anonymous-proxies.net
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto https

            transport http {
                tls
                tls_server_name ipn.anonymous-proxies.net
            }
        }
    }

    @myaccount_subdomain host myaccount.*
    handle @myaccount_subdomain {
        reverse_proxy https://myaccount.anonymous-proxies.net {
            header_up Host myaccount.anonymous-proxies.net
            transport http {
                tls
                tls_server_name myaccount.anonymous-proxies.net
            }
        }
    }

    # FIX 3: Custom fallback message for debugging
    handle {
        respond "Caddy-Error: Domain {host} did not match any handle" 404
    }

    handle_errors {
        respond "Caddy-Error-Handler: {err.status_code} {err.status_text}"
    }
}

:80 {
    redir https://{host}{uri} permanent
}
